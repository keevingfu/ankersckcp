#!/bin/bash

# Setup .env File Interactively
# Helps users create .env file safely with guided prompts

set -euo pipefail

# Color codes
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

clear

echo -e "${CYAN}"
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                            â•‘
â•‘   ðŸ”’ Secure Environment Setup                             â•‘
â•‘                                                            â•‘
â•‘   Interactive wizard to create .env file safely           â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}"

echo ""
echo -e "${BLUE}This wizard will help you create a secure .env file.${NC}"
echo ""
echo -e "${YELLOW}âš ï¸  Important Security Notes:${NC}"
echo "  â€¢ Your tokens will be stored ONLY in .env file"
echo "  â€¢ .env file is already in .gitignore (won't be committed)"
echo "  â€¢ Never share your .env file or tokens with anyone"
echo ""

read -p "Press Enter to continue, or Ctrl+C to cancel..."
echo ""

# Check if .env already exists
if [ -f .env ]; then
  echo -e "${YELLOW}âš ï¸  Warning: .env file already exists${NC}"
  echo ""
  read -p "Do you want to overwrite it? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Keeping existing .env file. Exiting..."
    exit 0
  fi
  echo ""
  echo "Backing up existing .env to .env.backup..."
  cp .env .env.backup
  echo -e "${GREEN}âœ… Backup created: .env.backup${NC}"
  echo ""
fi

# Start creating .env file
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ“ Creating .env file${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Create .env file with header
cat > .env << 'EOF'
# Environment Variables
# Auto-generated by setup-env.sh
# ðŸ”’ KEEP THIS FILE SECRET - DO NOT COMMIT TO GIT!

EOF

# ============================================
# GitHub Configuration
# ============================================
echo -e "${CYAN}â”â”â” GitHub Configuration â”â”â”${NC}"
echo ""
echo "Do you want to configure GitHub?"
echo ""
read -p "Configure GitHub? (Y/n) " -n 1 -r
echo
CONFIGURE_GITHUB=true
if [[ $REPLY =~ ^[Nn]$ ]]; then
  CONFIGURE_GITHUB=false
fi

if [ "$CONFIGURE_GITHUB" = true ]; then
  echo ""
  echo -e "${YELLOW}ðŸ“ GitHub Setup Instructions:${NC}"
  echo ""
  echo "1. Visit: https://github.com/settings/tokens"
  echo "2. Click 'Generate new token' â†’ 'Generate new token (classic)'"
  echo "3. Select scopes: repo, workflow"
  echo "4. Generate and copy the token"
  echo ""

  read -p "Enter your GitHub username: " GITHUB_USERNAME
  read -p "Enter your GitHub repository name (default: ankersckcp): " GITHUB_REPO
  GITHUB_REPO=${GITHUB_REPO:-ankersckcp}

  echo ""
  echo -e "${YELLOW}âš ï¸  Your token will be hidden while typing${NC}"
  read -s -p "Enter your GitHub Personal Access Token: " GITHUB_TOKEN
  echo ""

  if [ -n "$GITHUB_TOKEN" ]; then
    cat >> .env << EOF

# ============================================
# GitHub Configuration
# ============================================
GITHUB_TOKEN=${GITHUB_TOKEN}
GITHUB_REPO_URL=https://github.com/${GITHUB_USERNAME}/${GITHUB_REPO}.git

EOF
    echo -e "${GREEN}âœ… GitHub configuration saved${NC}"
  else
    echo -e "${YELLOW}â© Skipped GitHub (no token provided)${NC}"
  fi
else
  echo ""
  echo -e "${YELLOW}â© Skipping GitHub configuration${NC}"
fi

echo ""

# ============================================
# GitLab Configuration
# ============================================
echo -e "${CYAN}â”â”â” GitLab Configuration â”â”â”${NC}"
echo ""
echo "Do you want to configure GitLab?"
echo ""
read -p "Configure GitLab? (Y/n) " -n 1 -r
echo
CONFIGURE_GITLAB=true
if [[ $REPLY =~ ^[Nn]$ ]]; then
  CONFIGURE_GITLAB=false
fi

if [ "$CONFIGURE_GITLAB" = true ]; then
  echo ""
  echo -e "${YELLOW}ðŸ“ GitLab Setup Instructions:${NC}"
  echo ""
  echo "1. Visit: https://gitlab.com/-/profile/personal_access_tokens"
  echo "2. Click 'Add new token'"
  echo "3. Select scopes: api, read_repository, write_repository"
  echo "4. Generate and copy the token"
  echo ""

  read -p "Enter your GitLab username: " GITLAB_USERNAME
  read -p "Enter your GitLab repository name (default: ankersckcp): " GITLAB_REPO
  GITLAB_REPO=${GITLAB_REPO:-ankersckcp}

  echo ""
  echo -e "${YELLOW}âš ï¸  Your token will be hidden while typing${NC}"
  read -s -p "Enter your GitLab Personal Access Token: " GITLAB_TOKEN
  echo ""

  if [ -n "$GITLAB_TOKEN" ]; then
    cat >> .env << EOF

# ============================================
# GitLab Configuration
# ============================================
GITLAB_TOKEN=${GITLAB_TOKEN}
GITLAB_REPO_URL=https://gitlab.com/${GITLAB_USERNAME}/${GITLAB_REPO}.git

EOF
    echo -e "${GREEN}âœ… GitLab configuration saved${NC}"
  else
    echo -e "${YELLOW}â© Skipped GitLab (no token provided)${NC}"
  fi
else
  echo ""
  echo -e "${YELLOW}â© Skipping GitLab configuration${NC}"
fi

echo ""

# ============================================
# Slack Configuration (Optional)
# ============================================
echo -e "${CYAN}â”â”â” Slack Notifications (Optional) â”â”â”${NC}"
echo ""
echo "Do you want to configure Slack notifications now?"
echo "(You can skip this and configure it later)"
echo ""
read -p "Configure Slack? (y/N) " -n 1 -r
echo
CONFIGURE_SLACK=false
if [[ $REPLY =~ ^[Yy]$ ]]; then
  CONFIGURE_SLACK=true
fi

if [ "$CONFIGURE_SLACK" = true ]; then
  echo ""
  echo -e "${YELLOW}ðŸ“ Slack Setup Instructions:${NC}"
  echo ""
  echo "1. Visit: https://api.slack.com/apps"
  echo "2. Create a new app (From scratch)"
  echo "3. Enable 'Incoming Webhooks'"
  echo "4. Add webhook to workspace"
  echo "5. Copy the webhook URL"
  echo ""

  read -p "Enter your Slack Webhook URL: " SLACK_WEBHOOK_URL

  if [ -n "$SLACK_WEBHOOK_URL" ]; then
    cat >> .env << EOF

# ============================================
# Slack Notifications
# ============================================
SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}

EOF
    echo -e "${GREEN}âœ… Slack configuration saved${NC}"
  else
    echo -e "${YELLOW}â© Skipped Slack (no webhook provided)${NC}"
  fi
else
  echo ""
  echo -e "${YELLOW}â© Skipping Slack configuration${NC}"
  cat >> .env << 'EOF'

# ============================================
# Slack Notifications (Configure later)
# ============================================
# SLACK_WEBHOOK_URL=

EOF
fi

# Add remaining template sections
cat >> .env << 'EOF'

# ============================================
# Database & API Keys
# ============================================
# DATABASE_URL=
# OPENAI_API_KEY=

EOF

# ============================================
# Security Check
# ============================================
echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ”’ Security Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Verify .env is in .gitignore
if grep -q "^\.env$" .gitignore 2>/dev/null; then
  echo -e "${GREEN}âœ… .env is in .gitignore${NC}"
else
  echo -e "${YELLOW}âš ï¸  Adding .env to .gitignore...${NC}"
  echo ".env" >> .gitignore
  echo -e "${GREEN}âœ… .env added to .gitignore${NC}"
fi

# Set secure permissions
chmod 600 .env
echo -e "${GREEN}âœ… File permissions set to 600 (owner read/write only)${NC}"

# Verify not tracked
if git ls-files --error-unmatch .env 2>/dev/null; then
  echo -e "${RED}âŒ WARNING: .env is tracked by Git!${NC}"
  echo "Removing from Git tracking..."
  git rm --cached .env 2>/dev/null || true
  echo -e "${GREEN}âœ… .env removed from Git tracking${NC}"
else
  echo -e "${GREEN}âœ… .env is not tracked by Git${NC}"
fi

echo ""

# ============================================
# Summary
# ============================================
echo -e "${CYAN}"
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                            â•‘
â•‘   âœ… Setup Complete!                                      â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}"

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ“Š Configuration Summary${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ "$CONFIGURE_GITHUB" = true ]; then
  echo -e "  ${GREEN}âœ… GitHub configured${NC}"
else
  echo -e "  ${YELLOW}â© GitHub not configured${NC}"
fi

if [ "$CONFIGURE_GITLAB" = true ]; then
  echo -e "  ${GREEN}âœ… GitLab configured${NC}"
else
  echo -e "  ${YELLOW}â© GitLab not configured${NC}"
fi

if [ "$CONFIGURE_SLACK" = true ]; then
  echo -e "  ${GREEN}âœ… Slack configured${NC}"
else
  echo -e "  ${YELLOW}â© Slack not configured${NC}"
fi

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${YELLOW}ðŸš€ Next Steps:${NC}"
echo ""

if [ "$CONFIGURE_GITHUB" = true ] || [ "$CONFIGURE_GITLAB" = true ]; then
  echo "1. Push your code to remote repository:"
  echo "   ${CYAN}./scripts/secure-git-push.sh${NC}"
  echo ""
fi

if [ "$CONFIGURE_SLACK" = false ]; then
  echo "2. Configure Slack notifications (optional):"
  echo "   â€¢ Edit .env and add SLACK_WEBHOOK_URL"
  echo "   â€¢ Or run: ${CYAN}./scripts/setup-env.sh${NC} again"
  echo ""
fi

echo "3. Read the security guide:"
echo "   ${CYAN}cat SECURITY-GUIDE.md${NC}"
echo ""

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${GREEN}âœ… Your .env file is ready and secure!${NC}"
echo ""
echo -e "${RED}âš ï¸  IMPORTANT: Never commit .env to Git or share it with anyone!${NC}"
echo ""
